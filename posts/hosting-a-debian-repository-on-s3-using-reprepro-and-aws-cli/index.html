<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Hosting a Debian Repository on S3 using Reprepro and AWS CLI I. Đặt vấn đề Trong quá trình phát triển phần mềm, đặc biệt với hệ thống backend hoặc hạ tầng đóng gói nội bộ, việc phát hành các gói .deb nhanh chóng và có thể truy cập qua apt là một lợi thế rất lớn. Tuy nhiên, việc dựng hạ tầng riêng (như NGINX, APT server&mldr;) có thể phức tạp, tốn chi phí và không dễ mở rộng.\n"><title>Hosting a Debian Repository on S3 using Reprepro and AWS CLI</title><link rel=canonical href=https://phongthien99.github.io/posts/hosting-a-debian-repository-on-s3-using-reprepro-and-aws-cli/><link rel=stylesheet href=/scss/style.min.c18fe284aee63589fdafada4da66cb687206b45e982932d39401b71fbbde3a33.css><meta property='og:title' content="Hosting a Debian Repository on S3 using Reprepro and AWS CLI"><meta property='og:description' content="Hosting a Debian Repository on S3 using Reprepro and AWS CLI I. Đặt vấn đề Trong quá trình phát triển phần mềm, đặc biệt với hệ thống backend hoặc hạ tầng đóng gói nội bộ, việc phát hành các gói .deb nhanh chóng và có thể truy cập qua apt là một lợi thế rất lớn. Tuy nhiên, việc dựng hạ tầng riêng (như NGINX, APT server&mldr;) có thể phức tạp, tốn chi phí và không dễ mở rộng.\n"><meta property='og:url' content='https://phongthien99.github.io/posts/hosting-a-debian-repository-on-s3-using-reprepro-and-aws-cli/'><meta property='og:site_name' content='phongthien'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='debian'><meta property='article:tag' content='repository'><meta property='article:tag' content='aws'><meta property='article:tag' content='s3'><meta property='article:tag' content='reprepro'><meta property='article:tag' content='devops'><meta property='article:published_time' content='2025-06-14T00:00:00+00:00'><meta property='article:modified_time' content='2025-06-14T00:00:00+00:00'><meta name=twitter:title content="Hosting a Debian Repository on S3 using Reprepro and AWS CLI"><meta name=twitter:description content="Hosting a Debian Repository on S3 using Reprepro and AWS CLI I. Đặt vấn đề Trong quá trình phát triển phần mềm, đặc biệt với hệ thống backend hoặc hạ tầng đóng gói nội bộ, việc phát hành các gói .deb nhanh chóng và có thể truy cập qua apt là một lợi thế rất lớn. Tuy nhiên, việc dựng hạ tầng riêng (như NGINX, APT server&mldr;) có thể phức tạp, tốn chi phí và không dễ mở rộng.\n"><link rel="shortcut icon" href=/favicon.png><script src=https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0})</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b560a5e3646929f4.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🏅</span></figure><div class=site-meta><h1 class=site-name><a href=/>phongthien</a></h1><h2 class=site-description>Software Engineer</h2></div></header><ol class=menu-social><li><a href=https://github.com/phongthien99 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=linkedin rel=me><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/about-me/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About me</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#i-đặt-vấn-đề>I. Đặt vấn đề</a></li><li><a href=#ii-cách-giải-quyết>II. Cách giải quyết</a><ol><li><a href=#công-cụ-sử-dụng>Công cụ sử dụng:</a></li></ol></li><li><a href=#iii-thực-hiện>III. Thực hiện</a><ol><li><a href=#1-update-reposh--thêm>1. <code>update-repo.sh</code> – <strong>Thêm <code>.deb</code> vào repository</strong></a><ol><li><a href=#-nhiệm-vụ>✅ Nhiệm vụ:</a></li><li><a href=#-nội-dung-chính>🧩 Nội dung chính:</a></li><li><a href=#-cách-chạy>🛠️ Cách chạy:</a></li></ol></li><li><a href=#2-generate-sources-listsh--tạo-file>2. <code>generate-sources-list.sh</code> – <strong>Tạo file <code>sources.list</code> cho client</strong></a><ol><li><a href=#-nhiệm-vụ-1>✅ Nhiệm vụ:</a></li><li><a href=#-nội-dung-chính-1>🧩 Nội dung chính:</a></li><li><a href=#-cách-chạy-1>🛠️ Cách chạy:</a></li></ol></li><li><a href=#3-publishsh--đồng-bộ-hóa-toàn-bộ-repo-lên-s3>3. <code>publish.sh</code> – <strong>Đồng bộ hóa toàn bộ repo lên S3</strong></a><ol><li><a href=#-nhiệm-vụ-2>✅ Nhiệm vụ:</a></li><li><a href=#-nội-dung-chính-2>🧩 Nội dung chính:</a></li><li><a href=#-cách-chạy-2>🛠️ Cách chạy:</a></li></ol></li><li><a href=#4-thử-nghiêm>4. Thử nghiêm</a></li></ol></li><li><a href=#v-kết-luận>V. Kết luận</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/devops/>Devops
</a><a href=/categories/cloud/>Cloud</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/hosting-a-debian-repository-on-s3-using-reprepro-and-aws-cli/>Hosting a Debian Repository on S3 using Reprepro and AWS CLI</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jun 14, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><h1 id=hosting-a-debian-repository-on-s3-using-reprepro-and-aws-cli>Hosting a Debian Repository on S3 using Reprepro and AWS CLI</h1><h2 id=i-đặt-vấn-đề>I. Đặt vấn đề</h2><p>Trong quá trình phát triển phần mềm, đặc biệt với hệ thống backend hoặc hạ tầng đóng gói nội bộ, việc phát hành các gói <code>.deb</code> nhanh chóng và có thể truy cập qua <code>apt</code> là một lợi thế rất lớn. Tuy nhiên, việc dựng hạ tầng riêng (như NGINX, APT server&mldr;) có thể phức tạp, tốn chi phí và không dễ mở rộng.</p><p>Một giải pháp hiệu quả, đơn giản hơn là: <strong>host repository Debian trực tiếp trên Amazon S3</strong> và sử dụng <strong><code>reprepro</code></strong> để quản lý metadata.</p><hr><h2 id=ii-cách-giải-quyết>II. Cách giải quyết</h2><p>Chúng ta sẽ xây dựng một quy trình:</p><ul><li>Tạo repo Debian chuẩn bằng <code>reprepro</code>.</li><li>Cập nhật các gói <code>.deb</code> vào repo.</li><li>Đồng bộ repo lên Amazon S3.</li><li>Sinh ra file <code>.list</code> để client dễ cấu hình <code>apt</code>.</li></ul><h3 id=công-cụ-sử-dụng>Công cụ sử dụng:</h3><div class=table-wrapper><table><thead><tr><th>Công cụ</th><th>Vai trò</th></tr></thead><tbody><tr><td><code>reprepro</code></td><td>Tạo & quản lý cấu trúc Debian repo (<code>conf/</code>, <code>pool/</code>, <code>dists/</code>)</td></tr><tr><td><code>aws s3 sync</code></td><td>Đồng bộ thư mục repo lên Amazon S3</td></tr><tr><td>Shell Script</td><td>Tự động hóa các bước thêm gói, build metadata, và đồng bộ hóa</td></tr></tbody></table></div><hr><h2 id=iii-thực-hiện>III. Thực hiện</h2><h3 id=1-update-reposh--thêm>1. <code>update-repo.sh</code> – <strong>Thêm <code>.deb</code> vào repository</strong></h3><h4 id=-nhiệm-vụ>✅ Nhiệm vụ:</h4><ul><li>Kiểm tra và tạo cấu hình <code>conf/distributions</code> nếu chưa có.</li><li>Thêm gói <code>.deb</code> vào đúng <code>codename</code> bằng <code>reprepro</code>.</li></ul><h4 id=-nội-dung-chính>🧩 Nội dung chính:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -e
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>REPO_DIR</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>REPO_DIR</span><span class=k>:-</span><span class=p>./repo</span><span class=si>}</span><span class=s2>&#34;</span>      <span class=c1># Thư mục chứa repo</span>
</span></span><span class=line><span class=cl><span class=nv>DEB_FILE</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>                        <span class=c1># File .deb đầu vào</span>
</span></span><span class=line><span class=cl><span class=nv>DIST</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>                            <span class=c1># Codename (vd: v1.0)</span>
</span></span><span class=line><span class=cl><span class=nv>ARCH</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>ARCH</span><span class=k>:-</span><span class=nv>amd64</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>COMPONENT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>COMPONENT</span><span class=k>:-</span><span class=nv>main</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$DEB_FILE</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$DIST</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Usage: </span><span class=nv>$0</span><span class=s2> path/to/package.deb &lt;codename&gt;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> ! -f <span class=s2>&#34;</span><span class=nv>$DEB_FILE</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;❌ File not exist: </span><span class=nv>$DEB_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir -p <span class=s2>&#34;</span><span class=nv>$REPO_DIR</span><span class=s2>/conf&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DIST_FILE</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$REPO_DIR</span><span class=s2>/conf/distributions&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> ! grep -q <span class=s2>&#34;Codename: </span><span class=nv>$DIST</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$DIST_FILE</span><span class=s2>&#34;</span> 2&gt;/dev/null<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;➕ Adding new codename: </span><span class=nv>$DIST</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    cat &gt;&gt; <span class=s2>&#34;</span><span class=nv>$DIST_FILE</span><span class=s2>&#34;</span> <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>Origin: LocalCompany
</span></span></span><span class=line><span class=cl><span class=s>Label: LocalRepo
</span></span></span><span class=line><span class=cl><span class=s>Codename: $DIST
</span></span></span><span class=line><span class=cl><span class=s>Architectures: $ARCH
</span></span></span><span class=line><span class=cl><span class=s>Components: $COMPONENT
</span></span></span><span class=line><span class=cl><span class=s>Description: Auto-generated distribution $DIST
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;📦 Adding package: </span><span class=nv>$DEB_FILE</span><span class=s2> → codename: </span><span class=nv>$DIST</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>reprepro -b <span class=s2>&#34;</span><span class=nv>$REPO_DIR</span><span class=s2>&#34;</span> includedeb <span class=s2>&#34;</span><span class=nv>$DIST</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$DEB_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;✅ Completed!&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=-cách-chạy>🛠️ Cách chạy:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl>./update-repo.sh ./incoming/myapp_1.0.0.deb v1.0
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=2-generate-sources-listsh--tạo-file>2. <code>generate-sources-list.sh</code> – <strong>Tạo file <code>sources.list</code> cho client</strong></h3><h4 id=-nhiệm-vụ-1>✅ Nhiệm vụ:</h4><ul><li>Duyệt file <code>conf/distributions</code> để lấy danh sách các <code>Codename</code> và <code>Component</code>.</li><li>Sinh ra dòng cấu hình repo chuẩn cho <code>apt</code>.</li></ul><h4 id=-nội-dung-chính-1>🧩 Nội dung chính:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>REPO_URL</span><span class=o>=</span><span class=si>${</span><span class=nv>1</span><span class=k>:-</span><span class=s2>&#34;http://localhost/repo&#34;</span><span class=si>}</span>     <span class=c1># URL repo</span>
</span></span><span class=line><span class=cl><span class=nv>OUTPUT</span><span class=o>=</span><span class=si>${</span><span class=nv>2</span><span class=k>:-</span><span class=s2>&#34;localrepo.list&#34;</span><span class=si>}</span>              <span class=c1># Tên file output</span>
</span></span><span class=line><span class=cl><span class=nv>DISTRIBUTIONS_FILE</span><span class=o>=</span><span class=s2>&#34;repo/conf/distributions&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&gt; <span class=s2>&#34;</span><span class=nv>$OUTPUT</span><span class=s2>&#34;</span>  <span class=c1># Clear file</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>grep -E <span class=s1>&#39;^Codename:&#39;</span> <span class=s2>&#34;</span><span class=nv>$DISTRIBUTIONS_FILE</span><span class=s2>&#34;</span> <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span> <span class=p>|</span> <span class=k>while</span> <span class=nb>read</span> -r codename<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nv>component</span><span class=o>=</span><span class=k>$(</span>grep -A <span class=m>10</span> <span class=s2>&#34;Codename: </span><span class=nv>$codename</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$DISTRIBUTIONS_FILE</span><span class=s2>&#34;</span> <span class=p>|</span> grep -E <span class=s1>&#39;^Components:&#39;</span> <span class=p>|</span> awk <span class=s1>&#39;{$1=&#34;&#34;; print $0}&#39;</span> <span class=p>|</span> xargs -n1 <span class=p>|</span> sort -u <span class=p>|</span> xargs<span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[[</span> -n <span class=s2>&#34;</span><span class=nv>$component</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;deb [trusted=yes,arch=amd64] </span><span class=nv>$REPO_URL</span><span class=s2> </span><span class=nv>$codename</span><span class=s2> </span><span class=nv>$component</span><span class=s2>&#34;</span> &gt;&gt; <span class=s2>&#34;</span><span class=nv>$OUTPUT</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;⚠️ Warning: No components found for Codename: </span><span class=nv>$codename</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;✅ File </span><span class=nv>$OUTPUT</span><span class=s2> created:&#34;</span>
</span></span><span class=line><span class=cl>cat <span class=s2>&#34;</span><span class=nv>$OUTPUT</span><span class=s2>&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=-cách-chạy-1>🛠️ Cách chạy:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl>./generate-sources-list.sh https://my-s3-bucket.s3.amazonaws.com/repo my-repo.list
</span></span></code></pre></td></tr></table></div></div><p>File output <code>my-repo.list</code> có dạng:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>deb [trusted=yes,arch=amd64] https://my-s3-bucket.s3.amazonaws.com/repo v1.0 main
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=3-publishsh--đồng-bộ-hóa-toàn-bộ-repo-lên-s3>3. <code>publish.sh</code> – <strong>Đồng bộ hóa toàn bộ repo lên S3</strong></h3><h4 id=-nhiệm-vụ-2>✅ Nhiệm vụ:</h4><ul><li>Lấy cấu hình từ S3 về local.</li><li>Duyệt và thêm tất cả file <code>.deb</code> hiện có vào repo.</li><li>Xóa <code>repo/db</code> để tránh sync dữ liệu cache không cần thiết.</li><li>Sync toàn bộ repo lên S3.</li><li>Tạo file <code>.list</code> và upload nó lên S3.</li></ul><h4 id=-nội-dung-chính-2>🧩 Nội dung chính:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -e
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>S3_BUCKET</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>REPO_NAME</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>VERSION</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$3</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PUBLIC_HOST_URL</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$4</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> -z <span class=s2>&#34;</span><span class=nv>$S3_BUCKET</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$REPO_NAME</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$VERSION</span><span class=s2>&#34;</span> <span class=o>||</span> -z <span class=s2>&#34;</span><span class=nv>$PUBLIC_HOST_URL</span><span class=s2>&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;Usage: </span><span class=nv>$0</span><span class=s2> &lt;S3_BUCKET&gt; &lt;REPO_NAME&gt; &lt;VERSION&gt; &lt;PUBLIC_HOST_URL&gt;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>aws s3 sync s3://<span class=nv>$S3_BUCKET</span>/repo/conf ./repo/conf --exact-timestamps
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> file in ./*.deb<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  ./update-repo.sh <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$VERSION</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rm -rf ./repo/db
</span></span><span class=line><span class=cl>aws s3 sync ./repo s3://<span class=nv>$S3_BUCKET</span>/repo
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>./generate-sources-list.sh <span class=s2>&#34;</span><span class=nv>$PUBLIC_HOST_URL</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$REPO_NAME</span><span class=s2>.list&#34;</span>
</span></span><span class=line><span class=cl>aws s3 cp ./<span class=nv>$REPO_NAME</span>.list s3://<span class=nv>$S3_BUCKET</span>/source/<span class=nv>$REPO_NAME</span>.list
</span></span></code></pre></td></tr></table></div></div><h4 id=-cách-chạy-2>🛠️ Cách chạy:</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./publish.sh my-s3-bucket my-repo v1.0 https://my-s3-bucket.s3.amazonaws.com/repo
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=4-thử-nghiêm>4. Thử nghiêm</h3><p>Client có thể cấu hình APT như sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo curl -o /etc/apt/sources.list.d/my-repo.list https://my-s3-bucket.s3.amazonaws.com/source/my-repo.list
</span></span><span class=line><span class=cl>sudo apt update
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=v-kết-luận>V. Kết luận</h2><p>Việc sử dụng <code>reprepro</code> kết hợp với S3 là một giải pháp:</p><ul><li><strong>Nhẹ, đơn giản</strong></li><li><strong>Không cần web server</strong></li><li><strong>Dễ tích hợp CI/CD</strong></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/debian/>Debian</a>
<a href=/tags/repository/>Repository</a>
<a href=/tags/aws/>Aws</a>
<a href=/tags/s3/>S3</a>
<a href=/tags/reprepro/>Reprepro</a>
<a href=/tags/devops/>Devops</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/guide-to-running-gitlab-runner-locally-for-building-and-testing-ci/cd-pipelines/><div class=article-details><h2 class=article-title>Guide to Running GitLab Runner Locally for Building and Testing CI/CD Pipelines</h2></div></a></article><article><a href=/posts/effective-management-of-multiple-kubernetes-environments-with-helmfile/><div class=article-details><h2 class=article-title>Effective Management of Multiple Kubernetes Environments with Helmfile</h2></div></a></article><article><a href=/posts/migrating-data-from-mysql-to-postgresql-with-debezium-cdc/><div class=article-details><h2 class=article-title>Migrating Data from MySQL to PostgreSQL with Debezium CDC</h2></div></a></article><article><a href=/posts/streamlining-deployment-with-gitlab-ci/cd/><div class=article-details><h2 class=article-title>Streamlining Deployment with GitLab CI/CD</h2></div></a></article><article><a href=/posts/migration-mongodb-with-flyway/><div class=article-details><h2 class=article-title>Migration MongoDB With Flyway</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2025 phongthien</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>